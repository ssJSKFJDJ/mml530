		mml2mid Tcl/Tkインタフェース「tkmml2mid」v0.1d

						 新出尚之(にいで なおゆき)
						    nide@ics.nara-wu.ac.jp
								2008/01/25

1. はじめに―tkmml2midとは

  もともとmml2midには、本品と同じアーカイブで提供されている「コマンドラ
イン版」(UNIX, Win, DOS)とは別に、以前は「GUI版」(Windows)というものもあっ
たのですが、GUI版の方は事故でソースが失われたためV5.21までで開発が停止し
てしまいました。コマンドライン版の方はソースがあるので今後も保守を継続し
ていけるのですが、「非GUIプログラムは食わず嫌い」な人(世間には多いようで
す(^_^))は、このままでは、今後もしmml2midがバージョンアップされても、せっ
かくの新バージョンを利用できない状況になりかねませんでした。
  そこで開発した本品、tkmml2midとは、Tcl/Tk言語のスクリプトとして実現さ
れた、mml2midのGUIです。コマンドライン版のmml2midを本品と組み合わせるこ
とによって、GUI版mml2midとほぼ同様の使い方ができるようになるわけです。
一応、次のことを目標に作られました。

    [1] 以前のWindows用GUI版mml2midと同様の操作感覚を提供する
    [2] UNIXとWindowsでほぼ同じGUIを共通のスクリプトで提供
    [3] GUIをmml2mid本体から切り離して独立にすることにより、Windows用の
	mml2midをGUI版とコマンドライン版の2バージョンに分けて保守する手
	間の解消
    [4] ソース(というかスクリプトですが)を公開しておくことによって、不慮
	の事故による開発の中止を避ける:-):-)
    [5] フリーであるTcl/Tkの利用によって、誰でも(高額なC処理系を持たない
	人でも)開発できる状態に保つ


2 利用にあたって

2.1 動作環境

  UNIXあるいはWindowsで、Tcl/Tkのあまり古くないバージョンのある環境なら
動作するのではないかと思います。現在までに、作者が動作を確認している、あ
るいは動作報告が寄せられているのは以下の環境です。

	Linux 2.6.18 (Debian GNU/Linux etch), Tcl/Tk 8.4.12
	Linux 2.4.27 (Debian GNU/Linux sarge), Tcl/Tk 8.4.9
	Linux 2.0.36 (Plamo Linux 1.4.1), Tcl/Tk 8.0.5jp1.6
	Linux 2.0.36 (Plamo Linux 1.4.4), Tcl7.6jp/Tk4.2jp
	Windows 98, Tcl/Tk 8.0.5jp1.7
	Windows 95, Tcl7.6jp/Tk4.2jp
	Windows 98, Tcl/Tk 8.2

  Tcl/Tkはフリーなので、ftpサーバなどから入手して下さい。UNIXの場合、ソー
スからのコンパイルもできますが、各種PC-UNIXディストリビューションなど向
けのバイナリパッケージも提供されています(ので、PC-UNIXの場合の多くは改め
てTcl/Tkを入れることなく本品が使えます。便利)。Windows用にもバイナリパッ
ケージが提供されているようです。
  この他、もちろん以下のものが必要です。

	1) mml2midのコマンドライン版
		本品の入っているアーカイブに同梱のもの
	2) MIDIファイルを演奏できるコマンド
		UNIXでは   …TiMidity(ソフトウェアMIDI)あるいは
			     playmidi(ハードMIDIに依存)など
		Windowsでは…よく知りませんがWin98以降は標準でOKらしい?
			     Win95でもMIDI音源搭載機種なら標準でOKでしょう

  (注) Windows NTでは動作を確認していません(作者が使える環境がないため)。
もしかしたら設定ファイルの保存まわりが、現在のままではNTで動作しないかも
知れません(NTについてはよく知らないのでわかりません)。


2.2 インストール

2.2.1 Tcl/Tk等のインストール

  お使いのシステムにまだTcl/Tkがインストールされてなければ、インストール
します。Windowsの場合、拡張子「.tcl」をTcl/Tk(wish)に関連づけておきましょ
う。
  また、本アーカイブに同梱のコマンドライン版mml2midもインストールして下
さい。UNIXの場合、添付のドキュメントmml2mid.txtも、適当な箇所にインストー
ルしておきます。
  さらにUNIXの場合、MIDIファイル演奏コマンドもインストールし、単独での動
作を確認しておいて下さい。


2.2.2 本品のインストール

[1] UNIXの場合

  まず、添付のtkmml2mid.tclの文字コードと改行コードを、お使いのシステム
に合わせて直します。UNIX版のアーカイブに入っているものは、文字コードは日
本語EUC、改行コードはLFになっていますので、日本語EUCを主体に運用している
システムなら、コードを直す必要はないでしょう。Windows版に入っているもの
を利用する場合は、文字コードはMS漢字コード、改行コードはCR+LFになってい
ますので、nkfなど適当なコンバータを利用して、文字コードを適切なものに、
改行コードをLFに直して下さい。
  次に、このtkmml2midファイルに対し、必要な編集を施します。

   (a) 1行目の「#!/usr/bin/wish」の修正
	お使いのシステムのTcl/Tkの、wishコマンドのパスが「/usr/bin/wish」
	以外である場合、それに合わせて1行目を修正します。また、MacOSXの
	場合、1行目を「#!/usr/bin/env wish」に修正します(MacOSXでは/usr/
	bin/wishがシェルスクリプトであり、「#!/usr/bin/wish」では正常に
	働かないための措置です)。

   (b) MIDIプレーヤの設定
	先頭付近の
		set conf(playmidi_list) …
	で始まっている箇所がMIDIプレーヤの設定です。ここを、お使いのシス
	テムで利用できるMIDIプレーヤに合わせて変更して下さい。形式は
		{
		    {{日本語説明} {英語説明}}
		    {コマンドライン}
		}
	で1セットで、複数セット書くこともでき、その場合は先頭のものがデ
	フォルトとして扱われます。「日本語説明」や「英語説明」は、後述す
	る設定ウィンドウにおいて使われます。

   (c) エディタの設定
	MMLファイルの編集用エディタを選択する箇所です。メニューの「編集」
	ボタンをクリックした時にはここで設定したエディタが起動されます。
	MIDIプレーヤの設定箇所の直後に
		set conf(editor) {emacs}
	とあるのがそれですので、お好みに合わせ変更して下さい。

   (c) Webブラウザの設定
	tkmml2midには、mml2midのWebページを閲覧する機能があり、そのため
	に使うブラウザの設定です。この機能を使わないなら設定の必要はあり
	ません。エディタの設定箇所のすぐ後に
		set conf(webBrouser) {firefox}
	とあるのがそれで、お使いのシステムに合わせて変更します。

   (d) ドキュメント閲覧コマンドの設定
	さらにすぐ後に
		set conf(viewDoc) {}
	とある箇所です。UNIXでは、ヘルプとしてはmml2mid.txtを使うので、
	これを閲覧するコマンドの設定です。このままにしておくとtkmml2mid
	が自前で持つ内部簡易ビューアを使いますが、今のところこれにはサー
	チなどの機能がなく、単にテキストを上下にスクロールして見られるだ
	けです。lessなどを使いたい場合は、注釈部分を参考に、変更して下さ
	い。

   (e) ドキュメントファイルのありかの設定
	その少し先に
		set conf(docFile) "/usr/local/lib/mml2mid/mml2mid.txt"
	とある箇所です。mml2mid.txtをインストールしてある場所に合わせて
	変更します。

  最後に、修正し終わったtkmml2midを、(PATHの通った)適当なディレクトリに
コピーし、実行可能属性を付けます。


[2] Windowsの場合

  Windows版に入っているものを利用する場合は、添付のtkmml2mid.tclを、コマ
ンドライン版mml2mid.exeと同じディレクトリにコピーするだけです。多分、中
身を編集する必要はないでしょう。(但し、メニューの「編集」ボタンをクリッ
クした時に起動するエディタは、変更したいかも知れません。上記[1]「UNIXの
場合」の(c)を参照して直して下さい。標準では「メモ帳」になっています)
  UNIX版に入っているものを利用する場合は、文字コードをMS漢字コード、改行
コードをCR+LFに直してから利用して下さい。
  なお、GUI版mml2mid(最終はV5.21、http://hpc.jp/~mml2midで配布)に添付
のヘルプファイルmml2mid.hlpを、本品のヘルプとしても流用しますので、同じ
ディレクトリにmml2mid.hlpもコピーしておいて下さい。(当然、ヘルプの内容が
ちょっと古いことになりますが…。どなたか、新しいヘルプ作って下さい^^; ち
なみに作者はWindowsのヘルプを作成する環境を持っていません)


2.3 さて起動

[1] UNIXの場合

  シェルから「tkmml2mid」コマンドで起動します。引数としてMMLファイル名
を1つだけ指定することもできます。

[2] Windowsの場合

  以下のどちらかの方法で起動できます。

    (a) エクスプローラからtkmml2mid.tclをダブルクリック
    (b) DOSプロンプトから「start tkmml2mid.tcl」を実行

  (a)の代わりに、デスクトップやスタートメニューにtkmml2mid.tclのリンクを
作っておくのもよいでしょう。
  (b)の場合、引数としてMMLファイル名を1つだけ指定することもできます。な
お、(b)でもしtkmml2mid.tclをインストールしたディレクトリにPATHが通ってい
ない場合は、cdコマンドでそのディレクトリに移ってから実行して下さい。

  ヘルプファイルではドラッグ&ドロップも効くことになっていますが、現行の
tkmml2midではそれはできません。できるようにするにはどうすればいいんでしょ
う? tkmml2mid.batという補助バッチファイルを作るしかないのかな…


2.4 使い方

  まあ大体わかると思います。
  標準では、コンパイル後に自動演奏は行いません。「設定」メニューで設定し
て下さい。
  「ファイル」メニューの「コンパイル」は、選択されているMMLファイルより
新しいMIDIファイル(選択されているファイルと拡張子以外同名のもの)が存在す
れば、コンパイルを行いません。メインウィンドウ右上角より少し下の「コンパ
イル」ボタンも同じ働きです。その場合でも強制的にコンパイルさせたければ、
「ファイル」メニューで「強制コンパイル」を選んで下さい。

  「設定」メニューで出る設定ウィンドウの下部の5つのボタンについて説明を
加えておきます。設定ウィンドウで行える設定について、tkmml2midでは

	[1] tkmml2mid.tclに書き込まれている標準設定
	[2] 個人のホームディレクトリ(Windowsの場合はtkmml2mid.tclと同じ
	    ディレクトリ)に置かれる設定ファイル
	[3] 現在適用される設定
	[4] 設定ウィンドウに現れている設定

の4段階で管理しています。tkmml2midの起動時には[2](設定ファイルがなければ
[1])が読み込まれて[3]にコピーされます。そして、実際にmml2midでのコンパイ
ルを行う際に使うのはむろん[3]です。設定ウィンドウを開くと、[3]をコピーし
て[4]を作り、それをウィンドウで変更する状態になります。ここで

	「標準に戻す」ボタンは[1]を[4]にコピー
	「再読み込み」ボタンは[2]を[4]にコピー(設定ファイルがなければエラー)
	「設定を保存」ボタンは[4]を[2]にコピー(設定ファイルがなければ作成)
	「破棄」ボタンは[4]を破棄して設定ウィンドウを終了
	「適用」ボタンは[4]を[3]にコピーして設定ウィンドウを終了

という働きをします。従って「適用」ボタンを押さない限り、現在適用される設
定[3]は変わりません。例えば設定ウィンドウを起こして設定を変更し、「設定
を保存」「破棄」の順にボタンを押せば、現在適用される設定を変えずに、設定
ファイルだけ書き替わるわけです。(変な仕様かな…)


3. 問題点

 ・Tcl7.6/Tk4.2ではショートカットキーが効かない(Tcl/Tkのバグ?)
 ・現在のTcl/Tkのメニューバーの実装の制限のため、もしかしたら一部の環境
ではメニューバーの「設定」の起動に不具合があるかもしれない
 ・Windowsでの設定保存は、自前の設定ファイルを作るのでなくレジストリを設
定する手法を採るべきかも知れない(Tcl/Tk8.0以降にはその機能があるようだが、
作者がWindowsのレジストリについてよくわかってないので未着手)
 ・自前の内部簡易ヘルプビューアの機能(2.2.2[1](d)参照)が低すぎる
 ・Windows用のヘルプは、古いGUI版mml2midのものを転用する(2.2.2[2]参照)た
め古い
 ・今のところ、使用するエディタを設定画面で変更できない。MIDIプレーヤや
Webブラウザなども、設定画面で任意のものに変更したり、環境変数で変更した
りができない

  作者は、ある程度以上の規模のGUIプログラムを作るのも、ある程度以上の規
模のTcl/Tkプログラムを作るのも初めてなので、上記に限らず全般的に完成度が
低いような気がします^^;
  そもそも作者自身が、mml2midをわざわざGUIで操作する必要性を感じていない
人間なので(自分自身では別作の「marmalade」を使っています)、本品について
は可能なら、GUIのmml2midを必要とするどなたかが開発を引き継いで下さると嬉
しいです^^; そういう方が現れるまでは、必要な範囲での保守は行いますが…


4. 利用・配布条件

  本品は、当バージョン以降はmml2midの一部として配布されるので、利用・配
布条件もmml2midのそれと同じとします。


5. 更新履歴

  v0.1(2000.5.28)
      ・初版
  v0.1a(2000.6.5)
      ・外部エディタを呼ぶ「編集」ボタンを追加
  v0.1b(2000.6.18)
      ・Tcl/Tk8.1以降では、kstringコマンドがないため英語モードと判定して
	いたのを、日本語モードを使えるよう直した
      ・if文の書き方が1箇所間違っていたのを訂正
	  (以上は、ユーザの飯塚さんのパッチによります。また、この修正に
	   より飯塚さんからはWindows98+Tcl/Tk8.2での動作報告もして頂きま
	   した。感謝致します。)
  v0.1c(2000.7.11)
      ・本体には本質的な変更はない。mml2midの一部として配布されることに
	なったのに伴い、「About」の表示変更とドキュメントを書き換えただ
	け
  v0.1d(2008.1.25)
      ・実に7年半ぶりの修正
      ・Tcl/Tkの特定バージョン(少なくともDebian etchのtcl8.4.12-1.1)で、
	「expr F」がエラーにならなくなったためにtkmml2midがうまく動かな
	くなっていたのを修正
      ・デフォルト値の一部を、情勢の変化を鑑みて修正
